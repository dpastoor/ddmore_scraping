$PROBLEM oc 2 Emax on AUC BID CMAXM1 MHHY
$INPUT C ID TIME=WEEK MDV DV DVID AMT=AMTAUC CMAXM1 CL_IND MHHY BID REGI DOSE
$DATA  ..Simulated_Pimasertib_AeDropout.csv
       IGNORE=C IGNORE(DVID.EQ.3) 


$SUBR ADVAN=8 TOL=4
$MODEL
COMP=(CENTRAL)
COMP=(CUMHAZ)

$PK
IF(NEWIND.LE.1) CHLAST=0
MEDIANCL=39.4   

IF (TIME.EQ.0) PREVSCOR=0

B01=THETA(1) 
B11=THETA(2) 
B21=THETA(3) 
B02=THETA(4) 
B12=THETA(5) 
B22=THETA(6) 

FPS0=0                              
IF (PREVSCOR.EQ.0) FPS0=1
FPS1=0                              
IF (PREVSCOR.EQ.1.OR.PREVSCOR.EQ.2) FPS1=1
FPS2=0                             
IF (PREVSCOR.GE.3) FPS2=1

B1=FPS0*B01+FPS1*B11+FPS2*B21
B2=FPS0*B02+FPS1*B12+FPS2*B22


A1=B1
A2=A1+B2

IIV=ETA(1)                          


TVK=THETA(7)
K=TVK*EXP(ETA(2))


EMAX0=THETA(8)                      
EMAX1=THETA(9)                      
EMAX2=THETA(10)                     
ED50=EXP(THETA(11))*(CL_IND/MEDIANCL)**THETA(12)
EMAX=EMAX0 
IF(PREVSCOR.GE.1) EMAX=EMAX1 
;IF(PREVSCOR.GE.3) EMAX=EMAX2 




TCOV11=THETA(13) 
TCOV13=THETA(14) 
TCOV17=THETA(15) 


COV11=MHHY  
COV13=BID   
COV17=CMAXM1
MED17=0      

ALL1=(COV17-MED17)*TCOV17
ALL2=COV11*TCOV11+COV13*TCOV13
COV=ALL1+ALL2

LAMBDA= EXP(THETA(16))    
ALPHA = EXP(THETA(17))    
BETA1 = THETA(18)    


$DES

DADT(1)=-K*A(1)                           
DADT(2)= LAMBDA*ALPHA*T**(ALPHA-1)*EXP(BETA1*DOSE) 
                                                    

$ERROR
CALLFL=0


; Exposure
EXPO=A(1)  

$ERROR
CALLFL=0

EFF=EMAX*EXPO /(EXPO + ED50)



AA1=A1+IIV+EFF+COV
AA2=A2+IIV+EFF+COV

AA1M=AA1-IIV
AA2M=AA2-IIV


PREV=PREVSCOR
PREVSCOR=DV



PC0=1
PC1=EXP(AA1)/(1+EXP(AA1))
PC2=EXP(AA2)/(1+EXP(AA2))

P2=PC2
P1=PC1-PC2
P0=PC0-PC1

PC0M=1
PC1M=EXP(AA1M)/(1+EXP(AA1M))
PC2M=EXP(AA2M)/(1+EXP(AA2M))
P2M=PC2M
P1M=PC1M-PC2M
P0M=PC0M-PC1M

NSIM=IREP
Y=-1
IF (DVID.EQ.2.AND.DV.EQ.0) Y=P0
IF (DVID.EQ.2.AND.DV.EQ.1.OR.DV.EQ.2) Y=P1
IF (DVID.EQ.2.AND.DV.GE.3) Y=P2


CUMHAZ=A(2)
IF (DVID.EQ.5) THEN 
   Y=EXP(-CUMHAZ)
   CHLAST=CUMHAZ 
ELSE
   CHLAST=CHLAST 
ENDIF

IF (DVID.EQ.4) THEN 
   HAZARD=LAMBDA*ALPHA*TIME**(ALPHA-1)*EXP(BETA1*DOSE)
   Y=EXP(-CUMHAZ)*HAZARD
ENDIF

$THETA  
  -6.2   ; TH1_B01
   1.7   ; TH2_B11
  1.6    ; TH3_B21
   -3.1  ; TH4_B02
  -8.05  ; TH5_B12
   -0.2  ; TH6_B22

 $THETA  
  2.1    ; TH7_kel
   3.55  ; TH8_EMAX0
  0.01   ; TH9_EMAX1
  0 FIX  ; TH10_EMAX2
  4.2    ; TH11_LNED50
  0 FIX  ; TH12_CL

 $THETA 
  
   0.41   ; TH13_Cov11_MHHY
  -0.32   ; TH14_Cov13_BID
0.00024   ; TH15_COV17_CMAXM1

$THETA  
 -3.1     ; TH16 LNLAMBDA
(0,0.23,5)   ;  TH17 LNALPHA
0.0000001 ;  TH18 BETA
   
$OMEGA
   0.51         ; ETA1_logit
   0 FIX     ; ETA2_kel

$ESTIMATION METHOD=1 MAXEVALS=9999 PRINT=5 LIKE LAPLACE SIGDIGITS=1

$COV SIGL=6



$TABLE ID TIME EVID PREV DVID DV AMT MHHY B01 B11 B21 B02 B12 B22 B1 B2 A1 A2 AA1 AA2 PC0 PC1 PC2 P0 P1 P2
AA1M AA2M PC0M PC1M PC2M P0M P1M P2M IIV K EVID ETA1 EMAX ED50 EXPO EFF CMAXM1 CL_IND PREVSCOR BID REGI DOSE LAMBDA ALPHA BETA1
NOPRINT ONEHEADER FILE=ddmore.tab

